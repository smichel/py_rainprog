%% Zweiseitiges Layout
\documentclass[11pt,twoside,a4paper,fleqn]{report}
\usepackage[top=3cm, bottom=2.5cm, left=4cm, right=3cm]{geometry}

%% Schriftbild
\usepackage{lmodern}  % Latin Modern Zeichensatz
\usepackage[utf8]{inputenc}  % Unterstützung von Umlauten im Quelltext
\usepackage[T1]{fontenc}  % Korrekte Umlaute im PDF
\usepackage[english]{babel}  % Silbentrennung nach neuer Rechtschreibung
\renewcommand{\familydefault}{\sfdefault}  % Serifenlose Schrift
\usepackage{setspace}\onehalfspacing  % 1.5-facher Zeilenabstand
\renewcommand{\arraystretch}{1.5}  % 1.5-facher Zeilenabstand (Tabellen)
\setlength{\parindent}{0pt}  % Keine Einrückung am Beginn von Absätzen
\usepackage{emptypage}
\usepackage{placeins} % plaziert figures in die richtige section
\usepackage{multirow}
\sloppy  % Weniger Silbentrennung

% Kopfzeile: Section auf linker Seite, Subsection auf rechter Seite
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\fancyhf{}
\fancyhead[LE,RO]{\small{\thepage}}
\fancyhead[LO]{\small{\rightmark}}
\fancyhead[RE]{\small{\leftmark}}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0pt}
\fancypagestyle{plain}{%
  \fancyhead{}
  \renewcommand{\headrulewidth}{0pt}
}
%% Drawing:

\usepackage{tikz}
\usepackage{pgfplots}
\usetikzlibrary{math} %needed tikz library
\pgfplotsset{compat=newest}
\pgfplotsset{
	colormap={whitered}{color(0cm)=(white); color(1cm)=(orange!75!red)}
}
\usetikzlibrary{calc}
%\pgfmathdeclarefunction{gauss}{3}{%
%  \pgfmathparse{1/(sqrt(pow(#2,2)*2*pi))*exp(-(pow((#3-#1),2))/(2*pow(#2,2)))}%
%}
\pgfmathdeclarefunction{gauss}{4}{%A,mu,sigma,x
	\pgfmathparse{#1*(exp(-(pow((#4-#2),2))/(2*pow(#3,2))))}%
}
\pgfmathdeclarefunction{invgauss}{2}{%
	\pgfmathparse{sqrt(-2*ln(#1))*cos(deg(2*pi*#2))}%
}
\pgfmathsetseed{12344}%

%% Literaturverzeichnis (BibTex)
\usepackage{natbib}
\bibliographystyle{apalike}  % Layout des Literaturverzeichnisses

%% Verlinkung von Inhaltsverzeichnis, Bildern und Formeln
\usepackage[pagebackref]{hyperref}  % Verlinkung von URLs und Referenzen
\usepackage{color}  % Definition der Linkfarben
\definecolor{DarkRed}{rgb}{0.5,0,0}
\definecolor{Black}{rgb}{0,0,0}
\hypersetup{
  colorlinks,
  citecolor=Black,
  linkcolor=Black,
  urlcolor=Black}

%% Mathematikumgebung
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{amssymb}  % Erweiterte Bibliothek mathematischer Symbole
%\usepackage{euler}  % Serifenlose Schrift in Formelumgebungen
\usepackage[makeroom]{cancel}  % Durchstreichen von Termen
\renewcommand{\deg}{\ensuremath{^{\circ}}}  % Grad Zeichen im Text
\renewcommand{\epsilon}{\varepsilon}  % Nutze richtiges Epsilon

%% Grafikumgebungen
\usepackage{graphicx}  % Erweiterte Grafikumgebung
\usepackage{float}  % Automatische Positionierung von Bildern
\usepackage{subcaption}  %  Bildunterschriften für subfigures

%% Formeln, Bilder und Tabellen pro section nummerieren
\numberwithin{equation}{chapter}
\numberwithin{figure}{chapter}
\numberwithin{table}{chapter}

%% Listenumgebung
\usepackage{enumerate}
\usepackage{textcomp}  % Korrekte serifenlose Aufzählungszeichen

%% Farbige Umrahmungen
\usepackage{framed}
\definecolor{shadecolor}{rgb}{0.9,0.9,0.9}

%% Blindtext zum Testen des Layouts
\usepackage{blindtext}

%% Inhalt der Titelseite


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setcounter{section}{0}
\begin{document}
	\thispagestyle{empty}
	\begin{center}
		\hspace*{0pt}\vfill
		\begin{Huge}
			Probabilistic Radar-Based Precipitation Nowcasting
		\end{Huge}
		\vfill
		\begin{minipage}{0.5\textwidth}
			\centering
			%\begin{flushleft}
				\begin{large}
					Masterthesis by
				\end{large}
				\\\vspace{0.5cm}
				\begin{huge}
					Simon Michel
				\end{huge}
			%\end{flushleft}
		\end{minipage}
		\vfill
		
		\begin{minipage}{0.5\textwidth}
			\centering
			%\begin{flushleft}
				\begin{large}
					%Matrikelnummer: 6353359\\
					Universität Hamburg\\
					Fachbereich Geowissenschaften
				\end{large}
			%\end{flushleft}
		\end{minipage}
		\vfill
		
		\begin{minipage}{0.5\textwidth}
			\centering
			%\begin{flushleft}
				\begin{large}
					%Matrikelnummer: 6353359\\
					Erstgutachter: Dr. Marco Clemens\\
					Zweitgutachter: Prof. Dr. Felix Ament
				\end{large}
			%\end{flushleft}
		\end{minipage}
		\vfill
		\begin{minipage}{0.5\textwidth}
			\centering
			%\begin{flushleft}
				\begin{large}
					Hamburg, \today
				\end{large}
			%\end{flushleft}
		\end{minipage}
		\vfill
	\end{center}
	
	\newpage
	\thispagestyle{empty}
	\null
	\vfill
	Masterthesis im Fachbereich Geowissenschaften der Universität Hamburg\\
	Thema der Arbeit: \glqq Probabilistic Radar-Based Precipitation Nowcasting\grqq
	
	
\newpage
\renewcommand{\abstractname}{\huge \flushleft Abstract}
\begin{abstract}
\null
\end{abstract}
\thispagestyle{empty}
\pagestyle{empty}
\tableofcontents
\listoffigures
\listoftables
\newpage\pagestyle{fancy}
\chapter{Introduction}
\pagenumbering{arabic}
\chapter{Data}
\section{DWD Radar Data}
Boostedt DWD radar site: 54.0055° N, 10.04683° E, 124.6 m height

Precipitation scan: 0.5° ,following orographie (150 km range)
250m range gates, 1° azimuth steps
5 minute time resolution
C-Band
100 km x 100 km box around PATTERN radar position taken from the whole radar image
\section{PATTERN Radar Data}
% https://wetterradar.uni-hamburg.de/index.php?id=4035
PATTERN Hamburg radar position: 53.56833°N, 9.97997° E, ~80m height

60m range gates, 1° azimuth steps (20 km range)
30s time resolution
X-Band

\begin{figure}
	\centering
	\includegraphics[width=\textwidth,trim={0 0 0 0}, clip]{radarOverview.eps}
	\caption{Radaroverview. Red: Boostedt precip sweep, Black: Pattern precip sweep, Blue: Nesting area from boostedt radar sweep}
	\label{fig:radarOverview}
\end{figure}
\chapter{Methodology}
\section{Prognosis Model}
\subsection{Setting of Parameters}
\subsection{Gridding and Coordinate Transformation}
Both the DWD and PATTERN radar data are initially in a polar grid around their respective radar stations. For simplicity, nesting/comparability between both radars and to regard the curvature of the earth, the polar data is transformed and gridded to a Cartesian grid. 

This is done by using the Transverse Mercator projection transforming the polar grid coordinates to a Cartesian grid. The Transverse Mercator projection divides the Earth into 60 zones with  6° longitude in width. This reduces the distortion due to the curvature of the earth. Hamburg and its surrounding area lies in the EPSG zone 32632. 

\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{EPSG2.eps}
	\caption{EPSG Overview}
\end{figure}

Displacing the point of origin in the coordinate system from the point of the radar to the EPSG zone 32632.
\begin{equation}
	\begin{array}{lcl}
		x = r \cdot \cos(azi)\\
		y = r \cdot \sin(azi)
	\end{array}	
\end{equation}

\begin{equation}
	Z  = 10 \cdot \log _{10}(z)
\end{equation}

\begin{equation}
	z = aR^{b}
\end{equation}

\begin{equation}
	R = \frac{Z}{a}^{\frac{1}{b}}
\end{equation}
a and b are empirically-derived parameters. DWD and PATTERN use following values for the z-r relation for different radar reflectivities:

\begin{equation}
	\begin{array}{lcl}
		Z \le 36.5 \text{dBZ}: & a = 320, b = 1.4 \\
		36.5 \text{dBZ} < Z \le 44.0 \text{dBZ}: & a  = 200, b = 1.6 \\
		Z > 44.0 \text{dBZ}: & a = 77, b = 1.9
	\end{array}
\end{equation}

\subsection{Interpolation Methods}
\subsubsection{Barycentric Interpolation}
To transform the data from a polar grid to a Cartesian grid a Barycentric interpolation is applied to the radar data. The Barycentric interpolation is implemented following \cite{bary}. 

For the two dimensional barycentric interpolation the first step is to arrange the initial grid, here a polar grid around the radar site, into triangles. A possible way to do this is using the Delaunay Triangulation after \cite{delaunay}. This triangulation triangulates a set of points \textbf{P} so that no point in \textbf{P} is inside of the circumcircle of any triangle. Now the surrounding triangle is known for each point of the Cartesian grid.

In comparison to coordinate systems like Cartesian or polar coordinate systems where points are offsets to a origin, barycentric coordinates describe the position of points relative to a simplex (e.g. a line, a triangle or a tetrahedron) (\citealp{bary} and \citealp{baryBerrut}). In this case barycentric coordinates are used to compare positions of points to triangles. For triangles barycentric coordinates can be understood as area coordinates. The equations to calculate the barycentric coordinates $d,e,g$ of the point $P$ in the triangle $A,B,C$ are ratios of their respective triangles and the total triangle(Fig. \ref{fig:bary}). For example the coordinate $g$ is calculated by dividing the area of the triangle $CAP$ by the area of the triangle $ABC$ (\ref{eq:barycor}).

Now to get the value $f(x_p,y_p)$, the values of the points $A,B,C$ are weighted by their respective coordinate $d,e,g$ and summed up (eq. \ref{eq:baryeq}).
\begin{figure}
	\centering
	\begin{tikzpicture}
	
	\draw (0,0) -- (2,4) -- (4,0) -- (0,0);
	\fill (1.5,1.5) circle[radius=2pt];
	\fill (0,0) circle[radius=2pt];
	\fill (2,4) circle[radius=2pt];	
	\fill (4,0) circle[radius=2pt];	
	\draw (0,0) -- (1.5,1.5);
	\draw (2,4) -- (1.5,1.5);
	\draw (4,0) -- (1.5,1.5);
	
%	\draw (-0.3,-0.3) node {$(x_1,y_1)$};
%	\draw (4.3,-0.3) node {$(x_2,y_2)$};
%	\draw (2,4.3) node {$(x_3,y_3)$};
%	\draw (1.6,1) node {$(x,y)$};
	\draw (-0.3,-0.3) node {$A$};
	\draw (4.3,-0.3) node {$B$};
	\draw (2,4.3) node {$C$};
	\draw (1.8,1.7) node {$P$};
	
	\draw (1.6,0.5) node {$d$};
	\draw (2.4,1.8) node {$e$};
	\draw (1.2,1.8) node {$g$};
				
	\end{tikzpicture}
	\caption{Barycentric interpolation in a triangle}
	\label{fig:bary}
\end{figure}


\begin{equation}
	\begin{aligned}
		d = \dfrac{\Delta ABP}{\Delta ABC}\\
		e = \dfrac{\Delta BCP}{\Delta ABC}\\
		g = \dfrac{\Delta CAP}{\Delta ABC}
	\end{aligned}
	\label{eq:barycor}
\end{equation}

\begin{equation}
f(x_P,y_P) = d\,f(x_A,y_A)+e\,f(x_B,y_B)+g\,f(x_C,y_C)
\label{eq:baryeq}
\end{equation}

\subsubsection{Bilinear Interpolation}
Following a similiar approach as \cite{bilinear} the bilinear interpolation is implemented as the equation \ref{eq:bilinear}. The bilinear interpolation is used for datapoints which lie inside of a square Cartesian grid. This is depicted in Fig. \ref{fig:bilinear}. The point $(x,y)$ is surrounded by the points $(x_1,y_1),(x_2,y_1),(x_2,y_2),(x_1,y_2)$. Now to calculate the value $f(x,y)$, the values of the surrounding points $f(x_1,y_1),f(x_2,y_1),f(x_2,y_2),f(x_1,y_2)$ are weighted with their respective opposite areas $m,n,o,p $ and are summed up. 


\begin{figure}[H]
	\centering
	\begin{tikzpicture}
	\draw (0,0) rectangle (4,4);
	\draw (0,0) rectangle (1,1);
	\draw (1,1) rectangle (4,4);
	\fill (0,0) circle[radius=2pt];
	\fill (0,4) circle[radius=2pt];
	\fill (4,0) circle[radius=2pt];
	\fill (4,4) circle[radius=2pt];
	\fill (1,1) circle[radius=2pt];
	\draw (-0.3,-0.3) node {$(x_1,y_1)$};
	\draw (-0.3,4.3) node {$(x_1,y_2)$};
	\draw (4.3,-0.3) node {$(x_2,y_1)$};
	\draw (4.3,4.3) node {$(x_2,y_2)$};
	\draw (1.5,1.3) node {$(x,y)$};
	\draw (2.5,2.5) node {$m$};
	\draw (0.5,2.5) node {$n$};
	\draw (0.5,0.5) node {$o$};
	\draw (2.5,0.5) node {$p$};
	\end{tikzpicture}
	\caption{Bilinear Interpolation}
	\label{fig:bilinear}	
\end{figure}

\begin{equation}
	f(x,y) = m\,f(x_1,y_1)+n\,f(x_2,y_1)+o\,f(x_2,y_2)+p\,f(x_1,y_2)
	\label{eq:bilinear}
\end{equation}
\subsection{Displacement Detection}
In this thesis a combination of a cell and field-based algorithm is used.

In order to make a prognosis on the movement of precipitation fields a displacement vector is needed and several approximations are necessary. 

To find displacement vectors the following procedure is applied to the precipitation fields of the PATTERN and DWD radar.
\begin{enumerate}
	\item Detection of suitable patches in the precipitation field for tracking (Fig. \ref{fig:maximaOverview} and Fig. \ref{fig:maximaOverviewZoom}).
	\item Tracking of the patches (Fig. \ref{fig:displacement_t0} and Fig. \ref{fig:displacement_t1}) over the evolution of several time steps.
	\item If patches move out of the frame or tracking becomes undesirable new patches are searched in the current time step.
	\item Tracks of each patch are evaluated.
\end{enumerate}

\textbf{Detection of suitable patches} \\
In order to detect the displacement of the precipitation fields in the radar scans, suitable patches for tracking are needed. Selecting suitable patches is important for future tracking. Ideally the precipitation field inside each patch should remain Lagrangian persistent in the tracking time. Furthermore the precipitation field inside the patch should ideally have a distinguishable pattern so the  tracking via cross-correlation becomes more reliable (Fig. \ref{fig:displacement_t0} and \ref{fig:displacement_t1}). 

The patches are then iteratively selected by the following procedure. First the pixel with the highest rain rate inside the precipitation field is chosen. That pixel is then set as the middle point of the patch. The patch is a square with a side length of 2\,km for the PATTERN radar and a 12\,km for the DWD radar. The next patch is then located around the pixel with the second highest rain rate inside the precipitation field. The center point of the next patch needs to have a  minimum distance of 3\,km to other center points to reduce the overlap of the patches (Fig. \ref{fig:maximaOverviewZoom}). The location of the third patch is then centered around the pixel with next highest rain rate, again with a minimum distance of 3\,km to any other center point. This procedure is then continued until a specific number of patches is chosen or no more pixels with a minimum rain rate of over 0.5\,mm and a minimum distance of 3\,km to all other center points can be found inside the radar image.\\\\
\textbf{Tracking of the patches} \\
To get information about the displacement of the precipitation fields the position of the patches in the radar scans is tracked for 8 minutes for the PATTERN radar and 25 minutes for the DWD radar. This is done by estimating the displacement of each patch between two time steps by calculating the squared euclidean distance (Fig \ref{fig:displacement_t0} and \ref{fig:displacement_t1}). To estimate the displacement of one patch the patch in the radar image at the time $t$ (Fig. \ref{fig:displacement_t0}) is 'searched' in the radar image of the next time step $t + 1$ (Fig. \ref{fig:displacement_t1}). The search area is a square with double the side length of a patch, 4\,km for the PATTERN radar and 24\,km for the DWD radar. Then the squared euclidean distance is calculated between the patch and the total area of the 'search' area. The squared Euclidean distance is calculated with eq. \ref{eq:crosscorr} after \cite{crosscorr}. 
%TODO hier noch ne abbildung mit nem suchquadrat in die abbildung displacement_t1
%http://www.cs.umd.edu/~djacobs/CMSC426/Convolution.pdf
\begin{equation}
d^2_{q,p}(u,v) = \sum_{x,y}^{}\big[q(x,y)-p(x-u,y-v)\big]^2
\label{eq:crosscorr}
\end{equation}
In eq. \ref{eq:crosscorr} $q$ is the patch, the sum is over $x$, $y$ of the window containing the 'search' area $p$ positioned at $u$, $v$.\\
By calculating the squared Euclidean distance for every possible position of the patch over the 'search' area, you get a matrix of squared Euclidean distances for all possible positions (Fig. \ref{fig:corr_matrix}). Low values indicate a low Euclidean distance and high values a high Euclidean distance. A low Euclidean distance indicates a high similarity between the patch and the corresponding window used for the calculation of the squared Euclidean distance and a high Euclidean distance vice versa a low similarity.\\
The lowest squared Euclidean distance here is indicated by the black cross. The original position of the center point of the patch is indicated by the white cross. Thus the estimated displacement of the patch over one time step is the displacement between the white and black cross.\\
This procedure is then applied over the total time and all patches. If the center point of a patch moves out of the radar frame or the total number of rain pixels become lower than $xy$, then the patch is discarded and a new patch is selected by the procedure described before. 
\\\\
\textbf{Evaluation of the tracks} \\
After estimating the displacements for all patches over the specified time periods, the tracks (multiple displacements) need to be checked for errors. The estimation of the displacements is due to several reasons not perfect. Changes in the precipitation field like a strengthening or weakening rain rate can cause a wrong displacement detection. Furthermore, in case of stratiform precipitation, a very uniform precipitation pattern in the patch and in the 'search' area can lead to an erroneous displacement detection.\\
To differentiate good from bad tracks a orthogonal distance regression (ODR) (Fig. \ref{fig:orthogonaldist}) for each track is performed. The ODR calculates a line through a dataset of points which minimizes the squared distances from the points to their foot points on the line. \\
Now the squared distance of all points to their respective foot points on line (red lines in Fig. \ref{fig:orthogonaldist}) is summed up. If this sum is bigger than the halved distance between the first and last point (dotted line) the track is rejected. The example track in Fig \ref{fig:orthogonaldist} would be rejected.
From all accepted tracks a mean displacement in $x$ and $y$ direction is now calculated. Additionally the covariances between all displacements, $x$ and $x$,  $x$ and $y$, $y$ and $x$ and $y$ and $y$ are calculated to know how the displacements vary with each other. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{maximaOverview.eps}
	\caption{Boostedt radar, with the maxima marked with 'x'}
	\label{fig:maximaOverview}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{maximaOverviewZoom.eps}
	\caption{Section of the Boostedt radar, with the maxima marked with 'x',and red circles for showing the minimum distance between the local maxima}
	\label{fig:maximaOverviewZoom}
\end{figure}
\begin{figure}[h]
	\centering
	\begin{minipage}{0.48\textwidth}
		\includegraphics[width=\textwidth,trim={32mm 0 5mm 0},clip]{displacement_t0.eps}
		\caption{Sector of the boostedt radar at timestep t}
		\label{fig:displacement_t0}
	\end{minipage}\hfill
	\begin{minipage}{0.48\textwidth}
		\includegraphics[width=\textwidth,trim={32mm 0 5mm 0},clip]{displacement_t1.eps}
		\caption{Sector of the boostedt radar at timestep t+1}
		\label{fig:displacement_t1}
	\end{minipage}

\end{figure}

\begin{figure}[ht]
	\includegraphics[width=\textwidth,trim={5mm 0 5mm 0},clip]{Correlation_Matrix.eps}
	\caption{Correlation Matrix between the red area from \ref{fig:displacement_t0} and the total area of \ref{fig:displacement_t1}}
	\label{fig:corr_matrix}
\end{figure}

\begin{figure}[ht]
	\includegraphics[width=\textwidth,trim={0 0 5mm 0},clip]{displacement.eps}
	\caption{Tracks of several patches over 25 minutes.}
	\label{fig:displacement}
\end{figure}
\begin{figure}[h]
	\centering
	\begin{tikzpicture}[dot/.style={circle,inner sep=1pt,fill,name=#1},
	extended line/.style={shorten >=-#1,shorten <=-#1},
	extended line/.default=0.2cm]
	\begin{axis}[
	axis x line=center,
	axis y line=center,
	xtick={0,1,...,5},
	ytick={0,1,...,5},
	grid=major,
	xmin=0,
	ymin=0,
	xmax=5.5,
	ymax=5.5
	]
	\node [dot=A] at (1,0) {};
	\node [dot=B] at (2,4) {};
	\node [dot=C] at (4,3) {};
	\node [dot=D] at (3,3) {};
	\node [dot=E] at (4,5) {};
	\node [dot=F] at (4,2) {};
	\coordinate (G) at (0,0);
	\coordinate (H) at (5,5);
	\draw (G) -- (H);
	\draw [red] ($(G)!(A)!(H)$) -- (A);
	\draw [red] ($(G)!(B)!(H)$) -- (B);
	\draw [red] ($(G)!(C)!(H)$) -- (C);
	%\draw [red] ($(G)!(D)!(H)$) -- (D);
	\draw [red] (E) -- ($(G)!(E)!(H)$);
	\draw [red] (F) -- ($(G)!(F)!(H)$);
	\draw [dotted] (A) -- (E);
	\end{axis}
	\end{tikzpicture}
	\caption{Example for the orthogonal distance regression. The black line is the line which is calculated by the orthogonal distance regression. The red lines show the distance from the points to their respective foot points on the line. The dotted line shows the distance between the first and the last point of the tracks.}
	\label{fig:orthogonaldist}
\end{figure}
\subsection{Bivariate Normal Densities}
After \cite{duda} a two dimensional Gaussian distribution, also called bivariate normal density, is defined in the following.
With $\sigma_x \cdot\sigma_y = \sigma_{xy}$, where $\sigma_{xy}$ is the covariance of $x$ and $y$ and $\sigma_{x}$ is the variance of $x$, the correlation coefficient $\rho$ is defined by
\begin{equation}
	\rho = \dfrac{\sigma_{xy}}{\sigma_x\sigma_y}.
\end{equation}
With $\mu_x$ and $\mu_y$ as the means of all x and y displacements the bivariate normal density has the form
\begin{equation}
	\begin{multlined}
		p_{xy}(x,y)=\dfrac{1}{2\pi\sigma_x\sigma_y\sqrt{1-\rho^2}} \times \\ e^{-\dfrac{1}{2(1-\rho^2)}\bigg[\bigg(\dfrac{x-\mu_x}{\sigma_x}\bigg)^2-2\rho\bigg(\dfrac{x-\mu_x}{\sigma_x}\bigg)\bigg(\dfrac{y-\mu_y}{\sigma_y}\bigg)+\bigg(\dfrac{y-\mu_y}{\sigma_y}\bigg)^2\bigg]}.
	\end{multlined}
\end{equation}
Now with the 
\begin{figure}[h]
	\centering
	\begin{tikzpicture}[
	declare function={mu1=1;},
	declare function={mu2=1;},
	declare function={sigma1=1;},
	declare function={sigma2=1;},
	declare function={normal(\m,\s)=1/(\s*sqrt(2*pi))*exp(-(x-\m)^2/(2*\s^2));},
	declare function={bivar(\ma,\sa,\mb,\sb)= 1/(2*pi*\sa*\sb) * exp( -((x-\ma)^2/\sa^2 + (y-\mb)^2/\sb^2)/2 );}]
	\begin{axis}[
	colormap name=whitered,
	width=12cm,
	view={45}{65},
	enlargelimits=false,
	grid=major,
	domain=-1:3,
	y domain=-1:3,
	samples=26,
	xlabel=$x_1$,
	ylabel=$x_2$,
	zlabel={$P$},
	colorbar,
	colorbar style={
		at={(1.1,0)},
		anchor=south west,
		height=0.2*\pgfkeysvalueof{/pgfplots/parent axis height},
		title={$P(x,y)$}
	}
	]
	\addplot3 [surf] {bivar(mu1,sigma1,mu2,sigma2)};
	\addplot3 [domain=-1:3,samples=31, samples y=0, thick, smooth] (x,3,{normal(mu1,sigma1)});
	\addplot3 [domain=-1:3,samples=31, samples y=0, thick, smooth] (-1,x,{normal(mu2,sigma2)});
	
	\draw [black!50] (axis cs:-1,0,0) -- (axis cs:3,0,0);
	\draw [black!50] (axis cs:0,-1,0) -- (axis cs:0,3,0);
	
	\node at (axis cs:-1,1,0.10) [pin=165:$P(x)$] {};
	\node at (axis cs:1.5,3,0.0) [pin=-15:$P(y)$] {};
	\end{axis}
	\end{tikzpicture}
\end{figure}
\subsection{Importance Sampling}
\begin{figure}[h]
	\centering
	\begin{tikzpicture}
    \begin{axis}[
	axis x line=center,
	axis y line=center,
	xtick={0,1,...,4},
	ytick={0,1,...,4},
	grid=major,
	xmin=0,
	ymin=0,
	xmax=4,
	ymax=4
    ]
	\fill (3,3) circle[radius=2pt];

	\draw (3.32,3.3) node {$f(x,y)$};

	\foreach \x in {0, ..., 24} {%A,mu,sigma,x
		\pgfmathsetmacro{\xcoor}{rand}% x-coordinate
		\edef\temp{
			%\noexpand\coordinate (A) at ({gauss(1,0,1,\xcoor)},{gauss(1,0,1,\xcoor)});
			\noexpand\coordinate (A) at ({invgauss(rnd,rnd)/4+1},{invgauss(rnd,rnd)/4+1});
			\noexpand\draw (A) -- (3,3);	
			\noexpand\fill (A) circle[radius=1pt];
		}
	\temp
	}
	%\draw (1.5,0.5) --(3,3);
	%\fill (1.5,0.5) circle[radius=2pt];
	\draw (1.5,0.5) node {$f(x_s,y_s)$};

    \end{axis}
	\end{tikzpicture}
	\caption{Normal Distribution with $\mu$ = 1 and $\sigma$ = 1/4}
	\label{fig:importancesampling}
\end{figure}


\begin{equation}
	f_{t+1}(x,y) = \frac{1}{N}\sum_{s=0}^{N} f_{t}(x_s,y_s)
\end{equation}
\FloatBarrier
\section{Evaluation Methods}
\subsection{Point to Point Evaluation}
A rain threshold is set. Rainrates above that value e.g. 0.5 are considered to be rain, thus represented with a 1. Rainrates below that value are no rain, thus represented with a 0. Applying this threshold for the total rainfield creates a matrix of 0s and 1s. Now rainfields of the forecast and the reference values are compared.
\begin{enumerate}
	\item Hit(\textbf{H}): Both forecast and reference points show rain
	\item Miss(\textbf{M}): Reference point shows rain, forecast shows no rain
	\item False Alert(\textbf{FA}): Forecast shows rain, reference shows no rain
	\item Correct Rejection(\textbf{CR}): Both forecast and reference points show no rain
\end{enumerate}
From the ratios of these 4 cases it is possible to derive several skill scores:
\begin{equation}
\begin{array}{lcl}
	PC = \dfrac{H+CR}{H+M+FA+CR}\\
	POD = \dfrac{H}{H+M}\\
	FAR = \dfrac{FA}{FA+H}\\
	CSI = \dfrac{H}{H+M+FA}\\
	ORSS = \dfrac{H\cdot CR-FA\cdot M}{H\cdot CR+FA\cdot M}
\end{array}
\end{equation}
\chapter{Results and Discussion}
\chapter{Conclusion and Outlook}
\chapter{Acknowledgement}
\bibliography{References}
\chapter{Eidesstattliche Versicherung}
Ich versichere an Eides statt, dass ich diese Arbeit selbstständig verfasst und keine anderen als die angegebenen Hilfsmittel benutzt habe. Insbesondere habe ich keine im Literaturverzeichnis nicht genannten Internet-Quellen benutzt. Diese Arbeit habe ich vorher nicht in einem anderen Prüfungsverfahren eingereicht und die eingereichte schriftliche Fassung entspricht der Fassung auf dem elektronischen Speichermedium. Ich stimme einer Veröffentlichung dieser Arbeit zu.
\\
\\
\\
\\
\\
Simon Michel\\
Hamburg, \today
\end{document}

